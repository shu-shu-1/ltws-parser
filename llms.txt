# Little-Tree-Studio Docs — LLM Guide (llms.txt)

Last updated: 2025-12-14
Primary language: zh-CN (with brief EN summary)

This file is an AI-friendly condensed reference for:
- Little Tree Wallpaper Source Protocol v3.0（壁纸源协议 v3.0）

## 1) 协议概述（Wallpaper Source Protocol v3.0）

目标：用模块化 TOML 配置描述“壁纸源”，打包为不压缩 TAR（.ltws）以实现快速加载与易维护。

核心约束：
- 配置文件按功能拆分：`source.toml` / `config.toml` / `categories.toml` / `apis/*.toml`
- `.ltws` 为不压缩 TAR；打包时会生成 `manifest.json`
- 不允许在包内携带图片/字体等资源文件
- 图标（logo/icon）只能是 Base64 data URL 或外部 URL（不允许本地文件路径）


## 2) 文件结构

开发目录（示例）：
- `source.toml`（入口/元信息/文件引用）
- `config.toml`（全局请求配置，可选）
- `categories.toml`（分类定义）
- `apis/*.toml`（每个 API 一个文件）

打包后 `.ltws`（示例）：
- `source.toml`
- `config.toml`
- `categories.toml`
- `apis/*.toml`
- `manifest.json`（打包工具自动生成）


## 3) source.toml（入口）

必需字段（示例）：
- `scheme = "littletree_wallpaper_source_v3"`
- `identifier`（全局唯一，反向域名风格；仅小写字母/数字/点/下划线）
- `name`
- `version`（语义化版本 `x.y.z`）
- `categories`（`categories.toml` 路径）
- `apis`（glob/路径数组，例如 `["apis/*.toml"]`）

可选字段：
- `config`（默认 `"config.toml"`）
- `description` / `details`(Markdown) / `logo`(Base64或URL) / `footer_text`


## 4) config.toml（全局请求配置）

`[request]` 常用：
- `global_interval_seconds`（全局请求间隔；0=不限制）
- `timeout_seconds`
- `max_concurrent`
- `skip_ssl_verify`
- `user_agent`

`[request.headers]`：请求头字典

`[request.retry]`：
- `max_attempts`
- `backoff_base`（指数退避基数）
- `initial_delay_ms`

`[request.cache]`（全局“请求缓存”建议）：
- `enabled`
- `default_ttl_seconds`
- `max_memory_mb`

说明（重要）：
- 以上均为“建议配置”；客户端可根据自身策略（隐私/省流/用户设置等）忽略或覆盖。
- 缓存建议优先级（建议）：API 文件的 `[cache]` > `config.toml` 的 `[request.cache]` > 客户端默认/用户设置


## 5) categories.toml（分类定义）

- `[[categories]]`：每个分类一条；常用字段：`id/name/category/subcategory/subsubcategory/icon/description`
- `[template]`：默认模板（可选）
- `[level_icons]`：按层级值匹配图标（可选），并规定图标优先级：
  1) 分类自身 `icon`
  2) `level_icons`（subsubcategory→subcategory→category）
  3) `template.icon`
  4) 客户端默认
- `[[category_groups]]`：分类分组（可选）


## 6) apis/*.toml（API 定义）

每个 API 文件包含：
- 基本信息：`name/description/logo`
- `categories`：绑定到 `categories.toml` 中的分类 id 数组
- `[[parameters]]`：参数定义（choice/text/boolean；可 hidden）
- `[request]`：`url/method/timeout_seconds/interval_seconds` 等；可有 `[request.headers]`
- `[response]`：`format + type`
  - `format`: `json | toml | image_url | image_raw | static_list | static_dict`
  - `type`: `single | multi`
- `[mapping]`：字段映射
  - multi: `items + item_mapping`
- `[post_process]`：后处理（如拼接前缀域名）

路径语法：
- JSON 常用 JSON Pointer（`/a/b/0/c`，支持 `*` 与 `**` 的通配）
- TOML 可用点号路径（`data.url`）


## 7) 验证配置（API: [validation]）

用途：对“映射/后处理后的数据”做校验，帮助过滤无效条目、发现映射错误、做质量门槛。

字段：
- `required_fields`: `["image", "title", ...]`
- `field_patterns`: `[{ path, regex?, min_length?, max_length? }, ...]`
- `quality_rules`: `[{ path, min?, max? }, ...]`

注意：
- 本节描述“规则”；失败后的行为（报错/提示/跳过/回退）由客户端决定。


## 8) 错误处理（API: [error_handling]）

用途：声明请求/解析/映射异常时的建议处理策略（客户端可忽略/覆盖）。

字段（示例）：
- `http_codes`: `[{ code, message?, retry_after?, fallback? }, ...]`
  - `retry_after`：建议等待秒数；若响应含 `Retry-After` 头，建议客户端优先使用响应头
  - `fallback=true`：建议允许回退（如尝试备用 API/返回缓存/跳过）
- `on_empty_response`：例如 `"skip"`
- `on_mapping_failed`：例如 `"skip_item"`（多图模式下跳过单条）
- `fallback_to`（可选）：例如 `"backup_api"`，建议按 `apis/<name>.toml` 的文件名基名匹配


## 9) 缓存配置（API: [cache]）

用途：为“某个 API”声明缓存建议（缓存响应或解析后的结果列表），降低请求频率。

字段：
- `enabled`
- `ttl_seconds`
- `key_template`（建议包含关键参数/日期等，避免不同参数缓存互相污染）

注意：
- 是否缓存、缓存介质（内存/磁盘）、淘汰策略、加密与跨设备等均由客户端决定。


## 10) 多壁纸源分类合并（source.toml: [merge]）

关键澄清（重要）：
- 是否执行“合并”由客户端决定。
- `[merge]` 仅用于描述“当客户端选择进行合并时”的冲突处理与优先级等建议行为。

`[merge]`（示例字段）：
- `enabled`：参与合并的建议开关（客户端可忽略/覆盖）
- `strategy`：`same_id | same_name`
- `priority`：0-1000
- `metadata_source`：`high_priority | first_loaded | last_updated`
- `allow_metadata_override`：是否允许其他源覆盖本源分类元数据


## 11) 打包与工具（概览）

- 打包：`wallpaper-source-pack <source_dir> <output.ltws>`
- 验证：`wallpaper-source-validate <file.ltws>`

打包校验要点（概览）：
- 必需文件存在：`source.toml` / `categories.toml` / `apis/*.toml`
- `scheme` 必须是 `littletree_wallpaper_source_v3`
- 禁止携带资源文件（图片/字体等）


## 12) 变量系统（概览）

内置变量（示例）：
- 时间：`{{timestamp_ms}}, {{date_iso}}, {{date_cn}}, {{year}}, {{month}} ...`
- 随机：`{{random_string:N}}, {{random_int:MIN:MAX}}, {{random_hex:N}}`
- 屏幕变量：`{{screen_width}}, {{screen_height}}, {{screen_ratio}}`（由客户端提供）


---

## EN Summary (brief)

Little Tree Wallpaper Source Protocol v3.0 describes a modular TOML-based wallpaper source packaged as an uncompressed TAR (.ltws). Key files: source.toml (entry), config.toml (global request settings), categories.toml (category tree), apis/*.toml (API definitions). Icons must be Base64 data URLs or external URLs; no local asset files.

Per-API: request/response/mapping; optional validation, error_handling, and cache sections. Merge ([merge] in source.toml) only defines behavior *if* the client chooses to merge; the decision to merge is client-side.
